<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectrum Analyser</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>

<h1>Spectrum Analyzer</h1>
<button id="startButton">Start Audio Processing</button>
<canvas id="fftCanvas" width="600" height="300"></canvas>

<script>
    let audioContext;
    let analyser;
    let frequencyData;
    let source;

    async function initializeAudio() {
        // Setup audio
        await initAudio('../audio/yougotmail.mp3');
        // await initAudio('../audio/sin_4.wav');

        // Print some audio information to console
        const sampleRate = audioContext.sampleRate;
        const binSize = sampleRate / analyser.fftSize;
        console.log('Sample rate: ' + sampleRate);
        console.log('Bin size: ' + binSize);
        
        // Start audio and draw the spectrum
        playAudio();
        drawSpectrum();
    }

    async function initAudio(url) {
        // Get audio data
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();

        // Decode audio
        audioContext = new window.AudioContext();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        // Create AnalyserNode
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.8;

        // Initialize the frequency data array
        frequencyData = new Uint8Array(analyser.frequencyBinCount);

        // Pipe audio through analyser to output
        source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(analyser);
        analyser.connect(audioContext.destination);
    }

    function playAudio() {
        source.start()
    }

    function drawSpectrum() {
        // Request that the browser calls the drawSpectrum function again when it redraws the screen
        requestAnimationFrame(drawSpectrum);

        // Make sure the analyser and frequency data are initialized
        if (!analyser || !frequencyData) {
            console.log('Analyser and frequency data are not initialized');

            return;
        }

        // Get the frequency data from the analyser
        analyser.getByteFrequencyData(frequencyData);

        // Prepare the canvas for drawing
        const canvas = document.getElementById('fftCanvas');
        const canvasContext = canvas.getContext('2d');
        canvasContext.clearRect(0, 0, canvas.width, canvas.height);

        // Calculate the width of each bar
        const barWidth = canvas.width / analyser.frequencyBinCount;

        // Draw the spectrum
        let barHeight;
        let x = 0;
        // Go through each frequency bin
        for (let i = 0; i < analyser.frequencyBinCount; i++) {
            barHeight = frequencyData[i];

            // Draw a bar with a height corresponding to 'loudness' of the frequency
            canvasContext.fillStyle = 'rgb(255,50,50)';
            canvasContext.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

            // Move the drawing position to the right
            x += barWidth + 1;
        }
    }

    // Attach the initialization function to a button click
    document.getElementById('startButton').addEventListener('click', () => {
        initializeAudio();  // Start audio processing when the button is clicked
    });
</script>

</body>
</html>
